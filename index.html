import React, { useState, useEffect } from 'react';
import { Shuffle, FileDown, Users, GraduationCap } from 'lucide-react';

const TUTORS = [
  "HAK",
  "KPB",
  "GCZ",
  "VTV",
  "PJD",
  "FA",
  "NCV",
  "CMS"
];

// Configuration
const TOTAL_ROLL_NUMBERS = 60;
const EXCLUDED_ROLL = 57;

// Allocation rules
const HAK_COUNT = 6;
const STANDARD_COUNT = 7; // For everyone else except KPB

export default function App() {
  const [allocation, setAllocation] = useState([]);
  const [isPdfReady, setIsPdfReady] = useState(false);
  const [loading, setLoading] = useState(false);

  // Load jsPDF library dynamically
  useEffect(() => {
    const loadScript = (src) => {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    };

    Promise.all([
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'),
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js')
    ])
    .then(() => {
      setIsPdfReady(true);
    })
    .catch((err) => console.error('Failed to load PDF libraries', err));
  }, []);

  const handleAllocate = () => {
    setLoading(true);
    
    setTimeout(() => {
      // 1. Create array of students [1...60], excluding 57
      const students = Array.from({ length: TOTAL_ROLL_NUMBERS }, (_, i) => i + 1)
        .filter(num => num !== EXCLUDED_ROLL);

      // 2. Fisher-Yates Shuffle
      for (let i = students.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [students[i], students[j]] = [students[j], students[i]];
      }

      // 3. Custom Distribution Logic
      // Strategy: 
      // - HAK gets exactly 6
      // - Others (except KPB) get 7
      // - KPB gets the rest (which should be 11)
      
      const newAllocation = TUTORS.map(tutorName => ({
        name: tutorName,
        students: []
      }));

      let studentPointer = 0;

      // Helper to find tutor by name and assign students
      const assignToTutor = (name, count) => {
        const targetGroup = newAllocation.find(g => g.name === name);
        if (targetGroup) {
            // If count is null, take all remaining
            const takeCount = count === null ? (students.length - studentPointer) : count;
            targetGroup.students = students.slice(studentPointer, studentPointer + takeCount);
            studentPointer += takeCount;
        }
      };

      // A. Assign HAK (6)
      assignToTutor("HAK", HAK_COUNT);

      // B. Assign Others (7 each) - Skipping KPB for now
      const otherTutors = TUTORS.filter(t => t !== "HAK" && t !== "KPB");
      otherTutors.forEach(tutorName => {
        assignToTutor(tutorName, STANDARD_COUNT);
      });

      // C. Assign KPB (The Maximum / Remainder)
      assignToTutor("KPB", null);

      // 4. Sort student numbers for cleaner display within each tutor group
      newAllocation.forEach(group => {
        group.students.sort((a, b) => a - b);
      });

      setAllocation(newAllocation);
      setLoading(false);
    }, 400);
  };

  const handleDownloadPDF = () => {
    if (!window.jspdf || allocation.length === 0) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Title
    doc.setFontSize(20);
    doc.setTextColor(41, 128, 185);
    doc.text("Student-Tutor Allocation Report", 105, 15, { align: "center" });
    
    // Timestamp
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(`Generated on: ${new Date().toLocaleString()}`, 105, 22, { align: "center" });

    // Prepare table data
    const tableBody = allocation.map(group => [
      group.name,
      group.students.join(", "),
      group.students.length // Added count column for clarity given the uneven split
    ]);

    doc.autoTable({
      head: [['Tutor Name', 'Assigned Roll Numbers', 'Count']],
      body: tableBody,
      startY: 30,
      theme: 'grid',
      headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
      columnStyles: {
        0: { cellWidth: 40, fontStyle: 'bold' },
        1: { cellWidth: 'auto' },
        2: { cellWidth: 20, halign: 'center' }
      },
      styles: { fontSize: 10, cellPadding: 3 },
      didDrawPage: function (data) {
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(
          `Page ${doc.internal.getNumberOfPages()}`,
          data.settings.margin.left,
          doc.internal.pageSize.height - 10
        );
      }
    });

    doc.save("tutor-allocation.pdf");
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 p-4 sm:p-8">
      <div className="max-w-7xl mx-auto space-y-8">
        
        {/* Header */}
        <div className="text-center space-y-2">
          <div className="inline-flex items-center justify-center p-3 bg-blue-600 rounded-full shadow-lg mb-4">
            <GraduationCap className="w-8 h-8 text-white" />
          </div>
          <h1 className="text-3xl sm:text-4xl font-extrabold text-slate-900 tracking-tight">
            Tutor Allocation System
          </h1>
          <p className="text-lg text-slate-600 max-w-2xl mx-auto">
            Randomly assign students (1-60, excl. 57) to faculty mentors.
          </p>
        </div>

        {/* Controls */}
        <div className="flex flex-col sm:flex-row justify-center gap-4 pt-4">
          <button
            onClick={handleAllocate}
            disabled={loading}
            className={`
              flex items-center justify-center gap-2 px-8 py-4 rounded-xl text-lg font-semibold shadow-md transition-all transform hover:-translate-y-1
              ${loading 
                ? 'bg-slate-300 text-slate-500 cursor-not-allowed' 
                : 'bg-blue-600 text-white hover:bg-blue-700 hover:shadow-lg active:scale-95'}
            `}
          >
            <Shuffle className={`w-5 h-5 ${loading ? 'animate-spin' : ''}`} />
            {allocation.length === 0 ? 'Generate Allocation' : 'Re-Shuffle Allocation'}
          </button>

          {allocation.length > 0 && (
            <button
              onClick={handleDownloadPDF}
              disabled={!isPdfReady}
              className={`
                flex items-center justify-center gap-2 px-8 py-4 rounded-xl text-lg font-semibold shadow-md border-2 transition-all transform hover:-translate-y-1
                ${!isPdfReady 
                  ? 'bg-slate-100 border-slate-200 text-slate-400 cursor-wait' 
                  : 'bg-white border-slate-200 text-slate-700 hover:border-blue-200 hover:bg-blue-50 active:scale-95'}
              `}
            >
              <FileDown className="w-5 h-5" />
              Download PDF
            </button>
          )}
        </div>

        {/* Results Grid */}
        {allocation.length > 0 && (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 animate-in fade-in slide-in-from-bottom-4 duration-700">
            {allocation.map((group, idx) => (
              <div 
                key={idx} 
                className={`
                  rounded-2xl shadow-sm border overflow-hidden hover:shadow-md transition-shadow duration-300 flex flex-col
                  ${group.name === 'KPB' ? 'bg-blue-50 border-blue-200 ring-2 ring-blue-100' : 'bg-white border-slate-200'}
                `}
              >
                <div className={`
                  p-4 flex items-center justify-between border-b
                  ${group.name === 'KPB' ? 'bg-blue-100 border-blue-200' : 'bg-slate-50 border-slate-100'}
                `}>
                  <div className="flex items-center gap-3">
                    <div className={`
                      w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm
                      ${group.name === 'KPB' ? 'bg-blue-600 text-white' : 'bg-white text-slate-600 border border-slate-200'}
                    `}>
                      {group.name.substring(0,2)}
                    </div>
                    <div>
                      <h3 className="font-bold text-slate-800 leading-tight">{group.name}</h3>
                      <span className="text-xs font-medium text-slate-500 uppercase tracking-wider">
                        {group.name === 'KPB' ? 'Head Faculty' : 'Faculty'}
                      </span>
                    </div>
                  </div>
                  <span className={`
                    text-xs font-bold px-2 py-1 rounded-full
                    ${group.name === 'KPB' ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600'}
                  `}>
                    {group.students.length}
                  </span>
                </div>
                
                <div className="p-4 flex-grow">
                  <div className="flex flex-wrap gap-2">
                    {group.students.map((rollNo) => (
                      <span 
                        key={rollNo}
                        className={`
                          inline-flex items-center justify-center w-8 h-8 text-sm font-medium rounded-lg cursor-default transition-colors
                          ${group.name === 'KPB' 
                            ? 'bg-white text-blue-700 border border-blue-100 shadow-sm' 
                            : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}
                        `}
                      >
                        {rollNo}
                      </span>
                    ))}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}

        {/* Empty State */}
        {allocation.length === 0 && !loading && (
          <div className="text-center py-20 bg-white rounded-3xl border border-dashed border-slate-300">
            <Users className="w-16 h-16 text-slate-200 mx-auto mb-4" />
            <h3 className="text-xl font-medium text-slate-400">Ready to Allocate</h3>
            <p className="text-slate-400 mt-2">Click the button above to start the randomization.</p>
          </div>
        )}
      </div>
    </div>
  );
}
