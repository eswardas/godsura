<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCA Project Allocation | Admin Console</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: Outfit (Modern Headings) & Inter (UI) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- jsPDF and AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', 'sans-serif'],
                        heading: ['"Outfit"', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            950: '#09090b', // Zinc 950
                            900: '#18181b', // Zinc 900
                            800: '#27272a', // Zinc 800
                            700: '#3f3f46', // Zinc 700
                            600: '#52525b', // Zinc 600
                            border: '#27272a',
                        },
                        brand: {
                            500: '#6366f1', // Indigo
                            600: '#4f46e5',
                            glow: 'rgba(99, 102, 241, 0.15)'
                        }
                    },
                    backgroundImage: {
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #09090b;
            color: #e4e4e7;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }

        /* Animation Utilities */
        .fade-in-up { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

        /* Glass / Border Utilities */
        .glass-panel {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* --- NEW: High Visibility Input Styles for Custom Class --- */
        .input-dark {
            background-color: #27272a !important; /* Dark 800 */
            border: 1px solid #52525b; /* Dark 600 */
            color: #ffffff !important; /* White text */
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            display: block;
            margin-top: 0.25rem;
        }
        .input-dark::placeholder {
            color: #a1a1aa; /* Light Gray */
        }
        .input-dark:focus {
            outline: 2px solid #6366f1;
            border-color: transparent;
        }
    </style>
</head>
<body class="min-h-screen antialiased selection:bg-brand-500 selection:text-white">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass-panel border-b-0 border-b-dark-border">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            
            <!-- Logo Area -->
            <div class="flex items-center gap-4">
                <!-- Custom Geometric SVG Logo -->
                <div class="relative w-10 h-10 flex items-center justify-center">
                    <div class="absolute inset-0 bg-brand-500 rounded-xl opacity-20 blur-md"></div>
                    <svg class="relative w-10 h-10 text-white" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 5L32.9904 12.5V27.5L20 35L7.00962 27.5V12.5L20 5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M20 15V25" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M15 20H25" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="20" cy="20" r="2" fill="currentColor"/>
                        <circle cx="20" cy="5" r="2" fill="currentColor" class="text-brand-500"/>
                        <circle cx="32.99" cy="27.5" r="2" fill="currentColor" class="text-brand-500"/>
                        <circle cx="7.01" cy="27.5" r="2" fill="currentColor" class="text-brand-500"/>
                    </svg>
                </div>
                
                <div class="flex flex-col">
                    <h1 class="font-heading font-bold text-xl tracking-tight text-white leading-none">
                        Allocation<span class="text-brand-500">Console</span>
                    </h1>
                    <span id="navSubtitle" class="text-[10px] font-medium text-zinc-500 uppercase tracking-widest mt-1">MCA Dept • 2025-26</span>
                </div>
            </div>

            <!-- --- NEW: Mode Switcher --- -->
            <div class="flex items-center bg-dark-800 p-1 rounded-lg border border-dark-700">
                <button onclick="switchMode('MCA')" id="tabMCA" class="px-4 py-1.5 rounded-md text-xs font-semibold transition-all text-white bg-dark-600 shadow-sm">MCA Dept</button>
                <button onclick="switchMode('OTHER')" id="tabOther" class="px-4 py-1.5 rounded-md text-xs font-medium transition-all text-zinc-400 hover:text-white">Custom Class</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-12 space-y-12">
        
        <!-- Control Bar (MCA MODE) -->
        <div id="panelMCA" class="relative overflow-hidden rounded-2xl bg-dark-900 border border-dark-800 p-8 shadow-2xl">
            <!-- Subtle Grid Background -->
            <div class="absolute inset-0 opacity-[0.03]" style="background-image: linear-gradient(#fff 1px, transparent 1px), linear-gradient(90deg, #fff 1px, transparent 1px); background-size: 20px 20px;"></div>
            
            <div class="relative flex flex-col md:flex-row items-center justify-between gap-8">
                <div class="space-y-2 max-w-xl">
                    <h2 class="font-heading text-3xl font-semibold text-white">Project Guide Distribution</h2>
                    <p class="text-zinc-400 font-light leading-relaxed">
                        Algorithmically distribute Final Year MCA students (Roll 1-60) to faculty guides based on predefined capacity constraints.
                    </p>
                </div>

                <div class="flex items-center gap-4">
                    <button id="allocateBtn" onclick="handleAllocate()" class="action-btn group relative inline-flex items-center justify-center h-12 px-8 font-medium transition-all duration-200 bg-white text-zinc-950 rounded-lg hover:bg-zinc-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-zinc-500 focus:ring-offset-dark-900">
                        <div class="absolute inset-0 rounded-lg ring-1 ring-inset ring-black/10"></div>
                        <span class="mr-2 btn-icon transition-transform group-hover:rotate-180">
                            <!-- Refresh CW Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
                        </span>
                        <span class="btn-text">Run Allocation</span>
                    </button>

                    <button onclick="handleDownloadPDF()" class="download-btn hidden inline-flex items-center justify-center h-12 px-6 font-medium text-zinc-300 transition-all duration-200 bg-dark-800 border border-dark-700 rounded-lg hover:bg-dark-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-dark-700 focus:ring-offset-dark-900">
                        <!-- Download Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- --- NEW: Control Bar (OTHER MODE) --- -->
        <div id="panelOther" class="hidden relative overflow-hidden rounded-2xl bg-dark-900 border border-dark-800 p-8 shadow-2xl transition-all duration-300">
            <div class="space-y-6">
                <div class="flex items-center justify-between border-b border-dark-800 pb-4">
                    <h2 class="font-heading text-2xl font-semibold text-white">Custom Class Allocation</h2>
                    <div class="flex items-center gap-3">
                        <button onclick="handleAllocate()" class="action-btn bg-brand-600 hover:bg-brand-500 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors border border-transparent">
                            <span class="btn-text">Run Allocation</span>
                        </button>
                        <button onclick="handleDownloadPDF()" class="download-btn hidden bg-dark-800 hover:bg-dark-700 text-white px-4 py-2 rounded-lg border border-dark-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div>
                        <label class="block mb-1 text-xs font-bold text-zinc-300 uppercase tracking-wide">Class Name</label>
                        <input type="text" id="inputClassName" class="input-dark" placeholder="e.g. B.Tech CS Final Year">
                    </div>
                    <div>
                        <label class="block mb-1 text-xs font-bold text-zinc-300 uppercase tracking-wide">Total Students</label>
                        <input type="number" id="inputStudentCount" class="input-dark" placeholder="e.g. 60">
                    </div>
                    <div>
                        <label class="block mb-1 text-xs font-bold text-zinc-300 uppercase tracking-wide">Excluded Roll Nos</label>
                        <input type="text" id="inputExcluded" class="input-dark" placeholder="e.g. 5, 12, 44">
                    </div>
                    <div>
                        <label class="block mb-1 text-xs font-bold text-zinc-300 uppercase tracking-wide">No. of Guides</label>
                        <input type="number" id="inputGuideCount" class="input-dark" placeholder="Enter count..." oninput="renderGuideInputs()">
                    </div>
                </div>

                <!-- Dynamic Guide Inputs -->
                <div id="guideInputsContainer" class="hidden">
                    <label class="block mb-3 text-xs font-bold text-zinc-300 uppercase tracking-wide">Enter Guide Names</label>
                    <div id="guideInputsGrid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Inputs injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="flex flex-col items-center justify-center py-24 text-center rounded-2xl border border-dashed border-dark-800 bg-dark-900/50">
            <div class="w-16 h-16 mb-6 rounded-2xl bg-dark-800 flex items-center justify-center">
                <svg class="w-8 h-8 text-zinc-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
            </div>
            <h3 class="font-heading text-xl text-white font-medium">Awaiting Input</h3>
            <p class="text-zinc-500 mt-2 max-w-sm">System is ready. Initialize the allocation sequence to generate guide assignments.</p>
        </div>

        <!-- Grid -->
        <div id="resultsGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
            <!-- JS Injection -->
        </div>

    </main>

    <script>
        // --- Configuration ---
        const GUIDES = [
            "Hyderali K", 
            "Balachandran K P", 
            "Geevar C Zacharias", 
            "Vasudevan T V", 
            "Priya J D", 
            "Febin Aziz", 
            "Nowshad C V", 
            "C M Sulaikha"
        ];
        
        // --- Guide Short Codes Mapping ---
        const GUIDE_SHORT_CODES = {
            "Hyderali K": "HAK",
            "Balachandran K P": "KPB",
            "Geevar C Zacharias": "GCZ",
            "Vasudevan T V": "VTV",
            "Priya J D": "PJD",
            "Febin Aziz": "FA",
            "Nowshad C V": "NCV",
            "C M Sulaikha": "CMS"
        };

        // --- STUDENT NAMES LIST (Populated from User Data) ---
        // Array index 0 matches Roll 1, index 59 matches Roll 60.
        // Roll 57 (index 56) is Excluded.
        const STUDENT_NAMES_LIST = [
            "ABDUL JANEEB K",        // 1
            "ADITHYA DAS MP",        // 2
            "AKHILA",                // 3
            "AMINA P M",             // 4
            "ANAN P ABBAS",          // 5
            "ANJU E",                // 6
            "ANSILA NV",             // 7
            "ADHILA ASHRAF",         // 8
            "AYISHA RANDHA",         // 9
            "BASIM SHEBIN",          // 10
            "DEVIKA S",              // 11
            "DILBUR ROSHAN MOHAMED", // 12
            "ESWARDAS K NAIR",       // 13
            "FASAL RAHMAN",          // 14
            "FATHIMATH MUHSINA T P", // 15
            "FATHIMATH SANA C V",    // 16
            "FATHIMATHUL HANNATH",   // 17
            "HANNA",                 // 18
            "HENNA FATHIMA",         // 19
            "HENNA FATHIMA K",       // 20
            "HIBA NASRIN",           // 21
            "JALALA P V",            // 22
            "JASIR HASSAN K",        // 23
            "JASNA SHERIN",          // 24
            "JYOTHISH MOHAN A",      // 25
            "K ANSAR",               // 26
            "LAKSHMI H",             // 27
            "MEGHNA P",              // 28
            "MOHAMMED HAFIZ",        // 29
            "MOHAMMED NIYAS",        // 30
            "MOHAMMED SHIBILY",      // 31
            "MUHAMMED FAZIL C",      // 32
            "MUHAMMED REJAH E",      // 33
            "MUHSEENA JAS P",        // 34
            "MUHSINA",               // 35
            "NAADHI RAHMAN P",       // 36
            "NAFEESA K T",           // 37
            "NAHEEL K K",            // 38
            "NAJMATH MV",            // 39
            "NASEEBA SALAHUDHEEN",   // 40
            "NAYANA U",              // 41
            "NIHAL N",               // 42
            "RAMSHIYA M S",          // 43
            "RIFA",                  // 44
            "RIZVANA K A",           // 45
            "ROSHNA SHIRIN M",       // 46
            "SAFA MARIYAM",          // 47
            "SAIFUDEEN",             // 48
            "SARAN S KRISHNAN",      // 49
            "SETHULAKSHMI K",        // 50
            "SHAHNA S",              // 51
            "SHIFANA NASRIN",        // 52
            "SHIMNA SHERIN",         // 53
            "SNEHA K P",             // 54
            "SOMIN KURIYAKOSE",      // 55
            "SOORAJ K P",            // 56
            "EXCLUDED (Roll 57)",    // 57 (Excluded in Logic)
            "SWAFWANA SHERI K P",    // 58
            "VAISHNAVI K",           // 59
            "YUSRA"                  // 60
        ];

        const TOTAL_ROLL_NUMBERS = 60;
        const EXCLUDED_ROLL = 57;

        // Generate student objects mapping Roll No (i+1) to Name
        const STUDENTS_DATA = Array.from({ length: TOTAL_ROLL_NUMBERS }, (_, i) => {
            const roll = i + 1;
            // Map index to name. Index 0 is Roll 1.
            const name = STUDENT_NAMES_LIST[i] || `Student Name ${roll}`;
            
            return {
                roll: roll,
                name: name
            };
        }).filter(s => s.roll !== EXCLUDED_ROLL);

        const KPB_COUNT = 10;
        const STANDARD_COUNT = 7;

        // --- GLOBAL STATE ---
        let APP_MODE = 'MCA'; // 'MCA' or 'OTHER'
        let currentAllocation = [];
        let isGenerating = false;
        let currentClassName = "MCA Project Guide Allocation"; // For PDF Title

        // --- NEW: Toggle Logic ---
        function switchMode(mode) {
            APP_MODE = mode;
            
            const tabMCA = document.getElementById('tabMCA');
            const tabOther = document.getElementById('tabOther');
            const panelMCA = document.getElementById('panelMCA');
            const panelOther = document.getElementById('panelOther');
            const navSub = document.getElementById('navSubtitle');
            
            // Reset Results
            document.getElementById('resultsGrid').innerHTML = '';
            document.getElementById('emptyState').style.display = 'flex';
            document.querySelectorAll('.download-btn').forEach(btn => {
                btn.classList.add('hidden');
                btn.classList.remove('inline-flex');
            });

            if (mode === 'MCA') {
                tabMCA.className = "px-4 py-1.5 rounded-md text-xs font-semibold transition-all text-white bg-dark-600 shadow-sm";
                tabOther.className = "px-4 py-1.5 rounded-md text-xs font-medium transition-all text-zinc-400 hover:text-white";
                panelMCA.classList.remove('hidden');
                panelOther.classList.add('hidden');
                navSub.innerText = "MCA Dept • 2025-26";
            } else {
                tabOther.className = "px-4 py-1.5 rounded-md text-xs font-semibold transition-all text-white bg-dark-600 shadow-sm";
                tabMCA.className = "px-4 py-1.5 rounded-md text-xs font-medium transition-all text-zinc-400 hover:text-white";
                panelOther.classList.remove('hidden');
                panelMCA.classList.add('hidden');
                navSub.innerText = "Custom Configuration";
            }
        }

        // --- NEW: Render Custom Guide Inputs ---
        function renderGuideInputs() {
            const count = parseInt(document.getElementById('inputGuideCount').value) || 0;
            const container = document.getElementById('guideInputsContainer');
            const grid = document.getElementById('guideInputsGrid');
            
            grid.innerHTML = '';
            
            if (count > 0) {
                container.classList.remove('hidden');
                for (let i = 1; i <= count; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'input-dark';
                    input.placeholder = `Guide Name ${i}`;
                    input.id = `guideName_${i}`;
                    grid.appendChild(input);
                }
            } else {
                container.classList.add('hidden');
            }
        }

        function handleAllocate() {
            if (isGenerating) return;
            isGenerating = true;
            
            // Handle loading state for ALL buttons
            const btns = document.querySelectorAll('.action-btn');
            btns.forEach(btn => {
                btn.classList.add('opacity-75', 'cursor-wait');
                const btnText = btn.querySelector('.btn-text');
                const btnIcon = btn.querySelector('.btn-icon');
                if (btnText) btnText.innerText = "Processing...";
                if (btnIcon) btnIcon.classList.add('animate-spin');
            });

            setTimeout(() => {
                if (APP_MODE === 'MCA') {
                    generateMCAAllocation();
                } else {
                    generateCustomAllocation();
                }
                
                renderResults();

                isGenerating = false;
                btns.forEach(btn => {
                    btn.classList.remove('opacity-75', 'cursor-wait');
                    const btnText = btn.querySelector('.btn-text');
                    const btnIcon = btn.querySelector('.btn-icon');
                    if (btnText) btnText.innerText = "Re-Run Allocation";
                    if (btnIcon) btnIcon.classList.remove('animate-spin');
                });
                
                // Show PDF buttons
                document.querySelectorAll('.download-btn').forEach(btn => {
                    btn.classList.remove('hidden');
                    btn.classList.add('inline-flex');
                });

            }, 600);
        }

        function generateMCAAllocation() {
            currentClassName = "MCA Project Guide Allocation";
            const students = [...STUDENTS_DATA];

            // Fisher-Yates Shuffle
            for (let i = students.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [students[i], students[j]] = [students[j], students[i]];
            }

            // Distribution
            const newAllocation = GUIDES.map(guideName => ({ name: guideName, students: [] }));
            let studentPointer = 0;

            const assignToGuide = (name, count) => {
                const targetGroup = newAllocation.find(g => g.name === name);
                if (targetGroup) {
                    const takeCount = count === null ? (students.length - studentPointer) : count;
                    targetGroup.students = students.slice(studentPointer, studentPointer + takeCount);
                    studentPointer += takeCount;
                }
            };

            // Assign Balachandran K P (KPB)
            assignToGuide("Balachandran K P", KPB_COUNT);
            
            // Assign Standard Count to others
            GUIDES.filter(t => t !== "Balachandran K P").forEach(guideName => {
                assignToGuide(guideName, STANDARD_COUNT);
            });

            // Sort by Roll No for display
            newAllocation.forEach(group => group.students.sort((a, b) => a.roll - b.roll));
            currentAllocation = newAllocation;
        }

        function generateCustomAllocation() {
            // Get Custom Data
            const className = document.getElementById('inputClassName').value || "Custom Class Allocation";
            currentClassName = className;
            
            const totalStudents = parseInt(document.getElementById('inputStudentCount').value) || 0;
            const excludedStr = document.getElementById('inputExcluded').value;
            const excludedRolls = excludedStr ? excludedStr.split(',').map(s => parseInt(s.trim())) : [];
            
            const guideCount = parseInt(document.getElementById('inputGuideCount').value) || 0;
            const guides = [];
            for (let i = 1; i <= guideCount; i++) {
                const name = document.getElementById(`guideName_${i}`).value || `Guide ${i}`;
                guides.push(name);
            }

            if (totalStudents === 0 || guides.length === 0) {
                alert("Please enter valid student count and guides.");
                return;
            }

            // Create Students
            const students = [];
            for (let i = 1; i <= totalStudents; i++) {
                if (!excludedRolls.includes(i)) {
                    students.push({
                        roll: i,
                        name: "" // No name for custom
                    });
                }
            }

            // Shuffle
            for (let i = students.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [students[i], students[j]] = [students[j], students[i]];
            }

            // Distribute Fairly
            const allocation = guides.map(name => ({ name, students: [] }));
            students.forEach((student, index) => {
                const guideIndex = index % guides.length;
                allocation[guideIndex].students.push(student);
            });

            // Sort
            allocation.forEach(g => g.students.sort((a, b) => a.roll - b.roll));
            currentAllocation = allocation;
        }

        function renderResults() {
            const grid = document.getElementById('resultsGrid');
            const emptyState = document.getElementById('emptyState');
            
            emptyState.style.display = 'none';
            grid.innerHTML = '';

            currentAllocation.forEach((group, index) => {
                let badge = "";
                let initials = group.name.substring(0,2).toUpperCase();
                let studentsHtml = "";

                if (APP_MODE === 'MCA') {
                    // --- MCA Specific Badge & List ---
                    const isHOD = group.name === 'Hyderali K';
                    badge = isHOD 
                        ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-amber-500/10 text-amber-500 border border-amber-500/20 tracking-wide shrink-0">HOD</span>`
                        : `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-zinc-800 text-zinc-400 border border-zinc-700 shrink-0">FACULTY</span>`;
                    if (GUIDE_SHORT_CODES[group.name]) initials = GUIDE_SHORT_CODES[group.name];

                    // List with Names
                    studentsHtml = group.students.map(student => `
                        <div class="flex items-center gap-3 p-2 rounded-lg bg-dark-900/50 border border-dark-700 hover:border-dark-600 transition-colors w-full">
                            <span class="flex items-center justify-center h-8 w-10 text-xs font-bold font-mono
                                bg-teal-950 text-teal-400 border border-teal-800 rounded
                                shadow-sm shadow-teal-900/20 shrink-0">
                                ${student.roll}
                            </span>
                            <span class="text-sm text-zinc-300 font-medium truncate min-w-0" title="${student.name}">
                                ${student.name}
                            </span>
                        </div>`).join('');
                } else {
                    // --- Custom Mode: Generic Badge & Pills ---
                    badge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-zinc-800 text-zinc-400 border border-zinc-700 shrink-0">GUIDE</span>`;
                    const parts = group.name.split(' ');
                    if(parts.length > 1) initials = (parts[0][0] + parts[1][0]).toUpperCase();

                    // Grid of Pills (No Names)
                    studentsHtml = `<div class="flex flex-wrap gap-2">` + 
                        group.students.map(student => `
                            <span class="flex items-center justify-center h-8 w-10 text-sm font-bold bg-teal-950 text-teal-400 border border-teal-800 rounded-md shadow-sm shadow-teal-900/20 cursor-default hover:bg-teal-900 hover:text-white transition-colors">
                                ${student.roll}
                            </span>
                        `).join('') + `</div>`;
                }

                const borderColor = 'border-dark-700'; 
                const bgClass = 'bg-dark-800';

                const cardHtml = `
                    <div class="fade-in-up flex flex-col rounded-xl border ${borderColor} ${bgClass} shadow-lg group hover:border-dark-600 transition-colors duration-300 h-full" style="animation-delay: ${index * 50}ms">
                        <div class="p-5 border-b border-dark-700 flex items-start justify-between bg-white/5 gap-3">
                            <div class="flex items-center gap-3 min-w-0">
                                <div class="h-10 w-10 shrink-0 rounded-lg bg-dark-700 border border-dark-600 flex items-center justify-center font-heading font-bold text-white text-sm shadow-inner">
                                    ${initials}
                                </div>
                                <div class="flex flex-col min-w-0">
                                    <div class="flex flex-wrap items-center gap-2">
                                        <h3 class="font-heading font-semibold text-lg text-white leading-tight truncate">${group.name}</h3>
                                        ${badge}
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col items-end shrink-0">
                                <span class="text-2xl font-bold text-white leading-none">${group.students.length}</span>
                                <span class="text-[9px] text-zinc-400 uppercase font-medium">Students</span>
                            </div>
                        </div>
                        <div class="p-4 grow">
                            <div class="${APP_MODE === 'MCA' ? 'flex flex-col gap-2' : ''}">
                                ${studentsHtml}
                            </div>
                        </div>
                    </div>
                `;
                
                grid.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        function handleDownloadPDF() {
            if (!window.jspdf || currentAllocation.length === 0) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.setTextColor(20, 20, 20);
            doc.text(currentClassName, 14, 20);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on ${new Date().toLocaleDateString()}`, 14, 26);

            doc.setDrawColor(230, 230, 230);
            doc.line(14, 32, 196, 32);

            // --- DIFFERENT PDF LAYOUTS BASED ON MODE ---
            if (APP_MODE === 'MCA') {
                // ... MCA LOGIC (3 Columns, Grouped) ...
                const tableBody = [];
                const guideEndRowIndices = new Set();
                let rowIndex = 0;
                
                currentAllocation.forEach(group => {
                    let guideName = group.name;
                    if (group.name === 'Hyderali K') guideName += " (HOD)";
                    const studentCount = group.students.length;

                    group.students.forEach((student, index) => {
                        const row = [];
                        if (index === 0) {
                            row.push({ 
                                content: guideName, 
                                rowSpan: studentCount,
                                styles: { valign: 'middle', fontStyle: 'bold', fillColor: [252, 252, 252] } 
                            });
                        }
                        row.push(student.roll);
                        row.push(student.name);
                        tableBody.push(row);
                        if (index === studentCount - 1) guideEndRowIndices.add(rowIndex);
                        rowIndex++;
                    });
                });

                doc.autoTable({
                    head: [['Guide', 'Roll No', 'Student Name']],
                    body: tableBody,
                    startY: 40,
                    theme: 'grid',
                    styles: { fontSize: 9, cellPadding: 3, font: "helvetica", lineColor: [60, 60, 60], lineWidth: 0.1, valign: 'middle', textColor: [20, 20, 20] },
                    headStyles: { fillColor: [40, 40, 40], textColor: [255, 255, 255], fontStyle: 'bold', lineWidth: 0.1, lineColor: [60, 60, 60] },
                    columnStyles: { 0: { cellWidth: 50 }, 1: { cellWidth: 20, halign: 'center', fontStyle: 'bold' }, 2: { cellWidth: 'auto' } },
                    didDrawCell: function(data) {
                        if (data.section === 'body') {
                            let drawBoldLine = false;
                            if (data.column.index === 0) drawBoldLine = true;
                            else if (guideEndRowIndices.has(data.row.index)) drawBoldLine = true;

                            if (drawBoldLine) {
                                const d = data.doc; d.setDrawColor(0, 0, 0); d.setLineWidth(0.5);
                                d.line(data.cell.x, data.cell.y + data.cell.height, data.cell.x + data.cell.width, data.cell.y + data.cell.height);
                            }
                        }
                    }
                });

            } else {
                // ... CUSTOM LOGIC (2 Columns: Guide | Comma-Separated Rolls) ...
                const tableBody = currentAllocation.map(group => [
                    group.name,
                    group.students.map(s => s.roll).join(', ')
                ]);

                doc.autoTable({
                    head: [['Guide', 'Allocated Roll Numbers']],
                    body: tableBody,
                    startY: 40,
                    theme: 'grid',
                    styles: { 
                        fontSize: 10, 
                        cellPadding: 6, 
                        font: "helvetica",
                        lineColor: [60, 60, 60],
                        lineWidth: 0.1,
                        valign: 'top',
                        textColor: [20, 20, 20],
                        overflow: 'linebreak'
                    },
                    headStyles: { 
                        fillColor: [40, 40, 40],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        lineWidth: 0.1,
                        lineColor: [60, 60, 60]
                    },
                    columnStyles: {
                        0: { cellWidth: 60, fontStyle: 'bold' },
                        1: { cellWidth: 'auto' }
                    },
                    didDrawCell: function(data) {
                        if (data.section === 'body') {
                            const d = data.doc;
                            d.setDrawColor(0, 0, 0);
                            d.setLineWidth(0.5);
                            d.line(data.cell.x, data.cell.y + data.cell.height, data.cell.x + data.cell.width, data.cell.y + data.cell.height);
                        }
                    }
                });
            }

            const safeName = currentClassName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            doc.save(`${safeName}_allocation.pdf`);
        }
    </script>
</body>
</html>
